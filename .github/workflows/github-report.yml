name: GitHub Report RSS

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Generate RSS feed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $headers = @{ 'User-Agent' = 'Get-GitHubReport' }
          if ($env:GITHUB_TOKEN) {
              $headers['Authorization'] = "token $($env:GITHUB_TOKEN)"
          }

          $allRepos = @()
          $baseUri = 'https://api.github.com/users/michelderooij/repos'
          $page = 1
          $pageSize = 100

          do {
              $uri = '{0}?per_page={1}&page={2}' -f $baseUri, $pageSize, $page
              $pageData = Invoke-RestMethod -Uri $uri -Headers $headers
              $allRepos += $pageData
              $page++
          } while ($pageData.Count -eq $pageSize)

          $channelTitle = 'michelderooij GitHub Repositories'
          $channelLink = 'https://github.com/michelderooij'
          $channelDescription = 'Recent updates to public repositories'
          $lastBuildDate = (Get-Date).ToString('ddd, dd MMM yyyy HH:mm:ss K')

          $items = $allRepos |
              Sort-Object updated_at -Descending |
              ForEach-Object {
                  $pubDate = (Get-Date $_.updated_at).ToString('ddd, dd MMM yyyy HH:mm:ss K')
                  $descParts = @($_.description, "Watchers: $($_.watchers_count)", "Forks: $($_.forks_count)") | Where-Object { $_ }
                  $fullDesc = $descParts -join ' | '
                  @(
                      '    <item>'
                      "      <title>$($_.name)</title>"
                      "      <link>$($_.html_url)</link>"
                      "      <guid isPermaLink=""true"">$($_.html_url)</guid>"
                      "      <description><![CDATA[$fullDesc]]></description>"
                      "      <pubDate>$pubDate</pubDate>"
                      '    </item>'
                  ) -join "`n"
              }

          $rss = @(
              '<?xml version="1.0" encoding="UTF-8"?>'
              '<rss version="2.0">'
              '  <channel>'
              "    <title>$channelTitle</title>"
              "    <link>$channelLink</link>"
              "    <description>$channelDescription</description>"
              "    <lastBuildDate>$lastBuildDate</lastBuildDate>"
              $items
              '  </channel>'
              '</rss>'
          ) -join "`n"

          $outputPath = Join-Path $PWD 'rss/scripts.xml'
          $outputDir = Split-Path $outputPath
          if (-not (Test-Path $outputDir)) {
              New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
          }
          $rss | Set-Content -Path $outputPath -Encoding UTF8

      - name: Commit and push feed
        if: github.ref == 'refs/heads/master'
        shell: bash
        run: |
          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add rss/scripts.xml
            git commit -m "Update GitHub repos RSS feed"
            git push
          else
            echo "No changes to commit"
          fi
