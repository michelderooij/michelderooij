name: GitHub Report RSS

          @(
            '    <tr>'
            "      <td><a href=\"$($_.html_url)\">$($_.name)</a></td>"
            "      <td>$($_.watchers_count)</td>"
            "      <td>$($_.forks_count)</td>"
            "      <td>$($_.subscribers_count)</td>"
            "      <td>$lastUpdated</td>"
            '    </tr>'
          ) -join "`n"
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Generate repo HTML
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $headers = @{ 'User-Agent' = 'Get-GitHubReport' }
          if ($env:GITHUB_TOKEN) {
              $headers['Authorization'] = "token $($env:GITHUB_TOKEN)"
          }

          $allRepos = @()
          $baseUri = 'https://api.github.com/users/michelderooij/repos'
          $page = 1
          $pageSize = 100

          do {
              $uri = '{0}?per_page={1}&page={2}' -f $baseUri, $pageSize, $page
              $pageData = Invoke-RestMethod -Uri $uri -Headers $headers
              $allRepos += $pageData
              $page++
          } while ($pageData.Count -eq $pageSize)

          $rows = $allRepos |
              Where-Object { -not $_.fork } |
              Sort-Object name |
              ForEach-Object {
                  $lastUpdated = (Get-Date $_.updated_at).ToString('yyyy-MM-dd HH:mm')
                  @(
                      '    <tr>'
                      "      <td><a href=`"$($_.html_url)`">$($_.name)</a></td>"
                      "      <td>$($_.watchers_count)</td>"
                      "      <td>$($_.forks_count)</td>"
                      "      <td>$($_.subscribers_count)</td>"
                      "      <td>$lastUpdated</td>"
                      '    </tr>'
                  ) -join "`n"
              }

            $html = @(
              '<!DOCTYPE html>'
              '<html lang="en">'
              '<head>'
              '  <meta charset="UTF-8" />'
              '  <meta name="viewport" content="width=device-width, initial-scale=1.0" />'
              '  <title>michelderooij GitHub Repositories</title>'
              '</head>'
              '<body>'
              '  <table>'
              '    <thead>'
              '      <tr>'
              '        <th>Title</th>'
              '        <th>Stars</th>'
              '        <th>Forks</th>'
              '        <th>Subscribers</th>'
              '        <th>Last update</th>'
              '      </tr>'
              '    </thead>'
              '    <tbody>'
              $rows
              '    </tbody>'
              '  </table>'
              '</body>'
              '</html>'
            ) -join "`n"

            $outputPath = Join-Path $PWD 'snippets/scripts.html'
            $outputDir = Split-Path $outputPath
            if (-not (Test-Path $outputDir)) {
              New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
            }
            $html | Set-Content -Path $outputPath -Encoding UTF8

      - name: Commit and push feed
        if: github.ref == 'refs/heads/master'
        shell: bash
        run: |
          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add snippets/scripts.html
            git commit -m "Update GitHub repos HTML snippet"
            git push
          else
            echo "No changes to commit"
          fi
